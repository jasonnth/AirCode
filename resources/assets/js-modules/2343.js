__d(function(e,t,r,n){function i(e){return e&&e.__esModule?e:{default:e}}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=t(727),c=i(u),d=t(2338),h=t(2332),l=t(2341),m=i(l),p=t(2344),_=i(p),f=t(2345),v=i(f),g="messages",y=4,R=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.host,n=void 0===r?"bessie":r,i=t.withScopedAuth,s=void 0!==i&&i,o=t.sendFileBlob,u=void 0!==o&&o;a(this,e),this.resource=new c.default(g,{host:n}),this.limit=h.DEFAULT_PAGE_SIZE,this.withScopedAuth=s,this.XHRs={},this.sendFileBlob=u}return o(e,[{key:"loadItem",value:function(){function e(e,t){var r=this,n={message_thread_id:e,_with_scoped_auth:String(this.withScopedAuth)};return this.resource.member(t,n).then(function(t){return(0,m.default)([t.message].map(function(t){return(0,d.toItem)(e,t,r.resource.getBaseUrl(),r.resource.getHeaders())}))[0]})}return e}()},{key:"loadLatestItems",value:function(){function e(e){var t=this,r={message_thread_id:e,_with_scoped_auth:String(this.withScopedAuth),_order_by:"created_at",_order:"DESC",_limit:this.limit};return this.resource.collection(r).then(function(r){var n,i=t.processResponse(e,r);return{participants:i.participants,items:i.items,olderItemsAvailable:i.limited,meta:(n={},s(n,h.BACKWARD_CURSOR,i.cursor),s(n,h.FORWARD_CURSOR,i.cursor),n)}})}return e}()},{key:"loadNewerItems",value:function(){function e(e,t){var r=this,n={message_thread_id:e,_with_scoped_auth:String(this.withScopedAuth),_limit:this.limit,_before:t};return this.resource.collection(n).then(function(t){if(!t[g].length)return{participants:[],items:[],meta:{}};var n=r.processResponse(e,t);return{participants:n.participants,items:n.items,meta:s({},h.FORWARD_CURSOR,n.cursor)}})}return e}()},{key:"loadOlderItems",value:function(){function e(e,t){var r=this,n={message_thread_id:e,_with_scoped_auth:String(this.withScopedAuth),_limit:this.limit,_after:t};return this.resource.collection(n).then(function(t){if(!t[g].length)return{participants:[],items:[],meta:{olderItemsAvailable:!1}};var n=r.processResponse(e,t);return{participants:n.participants,items:n.items,olderItemsAvailable:n.limited,meta:s({},h.BACKWARD_CURSOR,n.cursor)}})}return e}()},{key:"setLimit",value:function(){function e(e){this.limit=e}return e}()},{key:"setHeaders",value:function(){function e(e){this.resource.setHeaders(e)}return e}()},{key:"processResponse",value:function(){function e(e,t){var r=this;return{cursor:t.metadata.cursor,limited:t[g].length===t.metadata.limit,items:(0,m.default)(t[g].map(function(t){return(0,d.toItem)(e,t,r.resource.getBaseUrl(),r.resource.getHeaders())})),participants:t[g].map(function(e){return(0,d.synthesizeParticipant)(e)})}}return e}()},{key:"sendText",value:function(){function e(e){var t={_with_scoped_auth:String(this.withScopedAuth)},r={content_type:h.CONTENT_TYPE.TEXT,content:{body:e.data.body},message_thread_id:e.threadID};return this.resource.create(t,r).then(function(t){var r=t.message;return{item:(0,d.toItem)(e.threadID,r),participant:(0,d.synthesizeParticipant)(r)}})}return e}()},{key:"uploadImage",value:function(){function e(e,t,r,n){var i=this,s=this.sendFileBlob?t:{uri:t};return new Promise(function(t,a){var o=new XMLHttpRequest;o.onload=function(){delete i.XHRs[n],o.status<400?t():a(new Error(o.response))},o.onerror=function(e){delete i.XHRs[n],a(e)},o.open("PUT",e),o.setRequestHeader("content-type",r),o.send(s),i.XHRs[n]=o})}return e}()},{key:"sendImage",value:function(){function e(e){var t=this,r={_with_scoped_auth:String(this.withScopedAuth)},n=(0,_.default)(e),i=this.sendFileBlob?n.type:(0,v.default)(n),s={content_type:h.CONTENT_TYPE.START_ASSET_UPLOAD,content:{asset_type:i},message_thread_id:e.threadID};return this.resource.create(r,s).then(function(r){var s=r.message.id,a=r.message.content.presigned_put_url;return t.uploadImage(a,n,i,e.id).then(function(){return s})}).then(function(n){var i={content_type:h.CONTENT_TYPE.FINISH_ASSET_UPLOAD,content:{start_asset_upload_message_id:n},message_thread_id:e.threadID};return t.resource.create(r,i).then(function(e){return e.message})}).then(function(r){return{item:(0,d.toItem)(e.threadID,r,t.resource.getBaseUrl(),t.resource.getHeaders()),participant:(0,d.synthesizeParticipant)(r)}})}return e}()},{key:"cancelImageUpload",value:function(){function e(e){var t=this.XHRs[e];return t&&t.readyState!==y?(delete this.XHRs[e],t.abort(),Promise.resolve(!0)):Promise.resolve(!1)}return e}()}]),e}();n.default=R},2343);